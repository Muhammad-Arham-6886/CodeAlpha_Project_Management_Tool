{% extends 'base.html' %}

{% block title %}Edit {{ project.name }} - ProjectFlow{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Edit Project: {{ project.name }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="editProjectForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="name" class="form-label">
                                        <i class="fas fa-project-diagram me-1"></i>Project Name *
                                    </label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ project.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="color" class="form-label">
                                        <i class="fas fa-palette me-1"></i>Project Color
                                    </label>
                                    <input type="color" class="form-control form-control-color" 
                                           id="color" name="color" value="{{ project.color|default:'#667eea' }}">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>Description
                            </label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="4" placeholder="Describe your project...">{{ project.description }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label">
                                        <i class="fas fa-flag me-1"></i>Status
                                    </label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="planning" {% if project.status == 'planning' %}selected{% endif %}>Planning</option>
                                        <option value="active" {% if project.status == 'active' %}selected{% endif %}>Active</option>
                                        <option value="on_hold" {% if project.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                                        <option value="completed" {% if project.status == 'completed' %}selected{% endif %}>Completed</option>
                                        <option value="cancelled" {% if project.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Priority
                                    </label>
                                    <select class="form-select" id="priority" name="priority">
                                        <option value="low" {% if project.priority == 'low' %}selected{% endif %}>Low</option>
                                        <option value="medium" {% if project.priority == 'medium' %}selected{% endif %}>Medium</option>
                                        <option value="high" {% if project.priority == 'high' %}selected{% endif %}>High</option>
                                        <option value="urgent" {% if project.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">
                                        <i class="fas fa-calendar-plus me-1"></i>Start Date
                                    </label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" 
                                           value="{% if project.start_date %}{{ project.start_date|date:'Y-m-d' }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">
                                        <i class="fas fa-calendar-check me-1"></i>End Date
                                    </label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" 
                                           value="{% if project.end_date %}{{ project.end_date|date:'Y-m-d' }}{% endif %}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="budget" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Budget (Optional)
                                    </label>
                                    <input type="number" class="form-control" id="budget" name="budget" 
                                           step="0.01" min="0" placeholder="0.00" 
                                           value="{% if project.budget %}{{ project.budget }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="progress" class="form-label">
                                        <i class="fas fa-chart-line me-1"></i>Project Progress
                                    </label>
                                    <input type="range" class="form-range mb-2" id="progressRange" 
                                           min="0" max="100" step="1" value="{{ project.progress|default:0 }}"
                                           oninput="updateProgressValue(this.value)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <input type="number" class="form-control w-25" id="progress" name="progress" 
                                               min="0" max="100" step="1" value="{{ project.progress|default:0 }}"
                                               oninput="updateProgressRange(this.value)">
                                        <div class="w-50 ms-3">
                                            <div class="progress">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     id="progressBar" style="width: {{ project.progress|default:0 }}%"
                                                     aria-valuenow="{{ project.progress|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                                                    <span id="progressText">{{ project.progress|default:0 }}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% url 'projects:project_detail' project.id %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                                <a href="{% url 'projects:delete_project' project.id %}" class="btn btn-outline-danger ms-2" 
                                   onclick="return confirm('Are you sure you want to delete this project? This action cannot be undone.')">
                                    <i class="fas fa-trash me-2"></i>Delete Project
                                </a>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Project
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Project Statistics -->
            <div class="card mt-4 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Project Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <h3 class="text-primary mb-1">{{ project.members.count }}</h3>
                                <small class="text-muted">Team Members</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h3 class="text-success mb-1">0</h3>
                                <small class="text-muted">Completed Tasks</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h3 class="text-warning mb-1">0</h3>
                                <small class="text-muted">Pending Tasks</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-info mb-1">
                                {% if project.start_date and project.end_date %}
                                    {% now "Y-m-d" as current_date %}
                                    {% if project.end_date|date:"Y-m-d" > current_date %}
                                        {{ project.end_date|timeuntil }}
                                    {% else %}
                                        Overdue
                                    {% endif %}
                                {% else %}
                                    N/A
                                {% endif %}
                            </h3>
                            <small class="text-muted">Time Remaining</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.getElementById('editProjectForm');
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value;
        if (name.trim().length < 3) {
            e.preventDefault();
            notificationManager.show('Project name must be at least 3 characters long.', 'error');
            return false;
        }
        
        // Validate dates
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
            e.preventDefault();
            notificationManager.show('Start date cannot be after end date.', 'error');
            return false;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        submitBtn.disabled = true;
    });
    
    // Auto-resize textarea
    const textarea = document.getElementById('description');
    if (textarea) {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        // Trigger initial resize
        textarea.dispatchEvent(new Event('input'));
    }
    
    // Color picker preview
    const colorInput = document.getElementById('color');
    const colorPreview = document.createElement('div');
    colorPreview.style.width = '20px';
    colorPreview.style.height = '20px';
    colorPreview.style.borderRadius = '50%';
    colorPreview.style.border = '2px solid #fff';
    colorPreview.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    colorPreview.style.marginLeft = '8px';
    colorPreview.style.backgroundColor = colorInput.value;
    
    colorInput.parentNode.style.display = 'flex';
    colorInput.parentNode.style.alignItems = 'center';
    colorInput.parentNode.appendChild(colorPreview);
    
    colorInput.addEventListener('change', function() {
        colorPreview.style.backgroundColor = this.value;
    });
});

// Progress synchronization functions
function updateProgressValue(value) {
    document.getElementById('progress').value = value;
    updateProgressBar(value);
}

function updateProgressRange(value) {
    document.getElementById('progressRange').value = value;
    updateProgressBar(value);
}

function updateProgressBar(value) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.width = value + '%';
    progressBar.setAttribute('aria-valuenow', value);
    progressText.textContent = value + '%';
    
    // Change color based on progress
    if (value < 25) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (value < 50) {
        progressBar.className = 'progress-bar bg-warning';
    } else if (value < 75) {
        progressBar.className = 'progress-bar bg-info';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }
}
</script>
{% endblock %}
